FROM rust:latest

WORKDIR /app

# Install dependencies for building (protoc for proto compilation)
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    protobuf-compiler \
    && rm -rf /var/lib/apt/lists/*

# Copy gladsheim (path dependency)
COPY gladsheim /app/gladsheim

# Copy Ragnarok files
COPY ragnarok/Cargo.toml ragnarok/build.rs ./ragnarok/
RUN cd ragnarok && cargo generate-lockfile 2>/dev/null || true

# Copy source code
COPY ragnarok/src ./ragnarok/src
COPY ragnarok/proto ./ragnarok/proto
COPY ragnarok/tests ./ragnarok/tests

WORKDIR /app/ragnarok

# Build the project
RUN cargo build --release

# Default command for tests
CMD ["cargo", "test", "--release"]
